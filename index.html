<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>üç¨ Friday Sweets Tracker üç≠</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    /* Clean, modern UI for adults */
    @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap');

    body {
      font-family: 'Montserrat', sans-serif;
      background: #f5f7fa;
      color: #2c3e50;
      padding: 40px 20px;
      max-width: 720px;
      margin: 0 auto;
    }

    h1, h2, h3 {
      text-align: center;
      color: #34495e;
      margin-bottom: 24px;
    }

    button {
      background-color: #2980b9;
      border: none;
      padding: 12px 26px;
      color: white;
      font-weight: 700;
      border-radius: 30px;
      cursor: pointer;
      font-size: 1.1em;
      box-shadow: 0 4px 8px rgba(41, 128, 185, 0.3);
      transition: background-color 0.3s ease, transform 0.2s ease;
      margin-top: 15px;
      display: inline-block;
      min-width: 120px;
      text-align: center;
    }
    button:hover {
      background-color: #1c5980;
      transform: translateY(-2px);
    }

    select, input[type="password"], input[type="number"], input[type="text"] {
      padding: 14px 16px;
      border-radius: 15px;
      border: 1.8px solid #bdc3c7;
      font-size: 1em;
      margin: 10px 0 20px;
      width: 100%;
      box-sizing: border-box;
      font-family: 'Montserrat', sans-serif;
      color: #2c3e50;
      transition: border-color 0.3s ease;
    }
    select:focus, input:focus {
      outline: none;
      border-color: #2980b9;
      box-shadow: 0 0 8px rgba(41, 128, 185, 0.4);
    }

    #pinSection, #childSection, #parentSection {
      background-color: white;
      border-radius: 20px;
      padding: 30px 40px;
      box-shadow: 0 10px 20px rgba(0,0,0,0.05);
      margin-top: 40px;
    }

    ul {
      list-style-type: none;
      padding-left: 0;
      max-height: 220px;
      overflow-y: auto;
      border: 1px solid #ecf0f1;
      border-radius: 15px;
      background: #fafafa;
      box-shadow: inset 0 2px 6px rgba(0,0,0,0.05);
      margin-top: 20px;
    }
    ul li {
      padding: 12px 18px;
      border-bottom: 1px solid #ecf0f1;
      font-weight: 600;
      color: #34495e;
    }
    ul li:last-child {
      border-bottom: none;
    }

    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0 12px;
      margin-top: 30px;
      font-size: 0.95em;
      color: #34495e;
    }
    thead tr {
      background-color: #2980b9;
      color: white;
      font-weight: 700;
      border-radius: 12px;
    }
    thead th {
      padding: 14px 12px;
      text-align: left;
      border-radius: 12px 12px 0 0;
    }

    tbody#parentExpenseTableBody {
      display: block;
      max-height: 280px;
      overflow-y: auto;
      width: 100%;
      background: white;
      border-radius: 0 0 12px 12px;
      box-shadow: 0 6px 18px rgba(41, 128, 185, 0.1);
    }
    tbody tr {
      display: table;
      width: 100%;
      table-layout: fixed;
      background: #ecf0f1;
      margin-bottom: 8px;
      border-radius: 10px;
      transition: background-color 0.25s ease;
    }
    tbody tr:hover {
      background: #d6e9fb;
    }
    tbody td {
      padding: 14px 12px;
      vertical-align: middle;
      text-overflow: ellipsis;
      white-space: nowrap;
      overflow: hidden;
    }

    p, label {
      font-weight: 600;
      font-size: 1.1em;
      margin: 14px 0 8px 0;
      color: #34495e;
    }

    span#childBalance {
      font-size: 2em;
      color: #2980b9;
      font-weight: 800;
      margin-bottom: 10px;
      display: inline-block;
    }

    #parentBalances {
      font-weight: 700;
      font-size: 1.25em;
      color: #2980b9;
      padding-left: 10px;
    }
    #parentBalances li {
      margin: 8px 0;
      border-left: 6px solid #2980b9;
      padding-left: 14px;
      color: #2c3e50;
    }

    /* Logout button style */
    #childLogoutBtn, #parentLogoutBtn {
      background-color: #e74c3c;
      margin-top: 30px;
      box-shadow: 0 5px 12px rgba(231, 76, 60, 0.5);
    }
    #childLogoutBtn:hover, #parentLogoutBtn:hover {
      background-color: #c0392b;
    }

  </style>
</head>
<body>
  <h1>üç¨ Friday Sweets Tracker üç≠</h1>

  <button id="googleSignInBtn">Sign in with Google</button>

  <div id="pinSection" aria-live="polite" role="region" aria-label="Child login section">
    <h2>Child Login</h2>
    <label for="childSelect">Select Your Name</label>
    <select id="childSelect" aria-required="true" aria-describedby="childSelectHelp">
      <option value="" disabled selected>Choose child</option>
      <option value="Khadija">Khadija</option>
      <option value="Omar">Omar</option>
      <option value="Emad">Emad</option>
    </select>
    <input
      type="password"
      id="pinInput"
      maxlength="4"
      placeholder="Enter 4-digit PIN"
      aria-label="Child 4-digit PIN"
    />
    <button id="verifyPinBtn">Verify PIN</button>
  </div>

  <div id="childSection" aria-live="polite" role="region" aria-label="Child dashboard">
    <h2>Welcome, <span id="childNameDisplay"></span>!</h2>
    <p>Your Balance:</p>
    <span id="childBalance">Loading...</span> Dhs

    <label for="childDesc">Add an expense description</label>
    <input id="childDesc" type="text" placeholder="What did you buy?" />

    <label for="childAmount">Amount spent (Dhs)</label>
    <input id="childAmount" type="number" min="0.01" step="0.01" placeholder="Amount" />

    <button id="childAddExpenseBtn">Add Expense</button>

    <h3>Your Transactions</h3>
    <ul id="childTransactions" aria-live="polite" aria-relevant="additions"></ul>

    <button id="childLogoutBtn">Log Out</button>
  </div>

  <div id="parentSection" aria-live="polite" role="region" aria-label="Parent dashboard">
    <h2>Parent Panel</h2>

    <p>Current Balances:</p>
    <ul id="parentBalances" role="list"></ul>

    <h3>Add Transaction for Child</h3>
    <label for="parentChildSelect">Select Child</label>
    <select id="parentChildSelect">
      <option value="Khadija">Khadija</option>
      <option value="Omar">Omar</option>
      <option value="Emad">Emad</option>
    </select>

    <label for="parentDesc">Transaction Description</label>
    <input id="parentDesc" type="text" placeholder="Description" />

    <label for="parentAmount">Amount (positive to add, negative to take away)</label>
    <input id="parentAmount" type="number" step="0.01" placeholder="Amount (+ or -)" />

    <button id="parentAddExpenseBtn">Add Transaction</button>

    <h3>All Transactions</h3>
    <table>
      <thead>
        <tr>
          <th>Child</th>
          <th>Description</th>
          <th>Amount (Dhs)</th>
          <th>Date</th>
          <th>Added By</th>
        </tr>
      </thead>
      <tbody id="parentExpenseTableBody"></tbody>
    </table>

    <button id="parentLogoutBtn">Log Out</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getFirestore,
      collection,
      addDoc,
      query,
      where,
      onSnapshot,
      Timestamp
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import {
      getAuth,
      signInWithPopup,
      GoogleAuthProvider,
      onAuthStateChanged,
      signOut
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyAbpN6PKSiyD5nNcZNNRgshTTwUTs4A0po",
      authDomain: "friday-sweets.firebaseapp.com",
      projectId: "friday-sweets",
      storageBucket: "friday-sweets.appspot.com",
      messagingSenderId: "772417277599",
      appId: "1:772417277599:web:f69df19ae71030af515caa"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    // Child PINs & parent emails
    const pins = { Khadija: "1111", Omar: "2222", Emad: "3333" };
    const parents = ["prof.ahmedemad@gmail.com"];

    // Elements
    const googleSignInBtn = document.getElementById("googleSignInBtn");
    const pinSection = document.getElementById("pinSection");
    const childSection = document.getElementById("childSection");
    const parentSection = document.getElementById("parentSection");

    const childSelect = document.getElementById("childSelect");
    const pinInput = document.getElementById("pinInput");
    const verifyPinBtn = document.getElementById("verifyPinBtn");
    const childNameDisplay = document.getElementById("childNameDisplay");
    const childBalanceSpan = document.getElementById("childBalance");
    const childDesc = document.getElementById("childDesc");
    const childAmount = document.getElementById("childAmount");
    const childAddExpenseBtn = document.getElementById("childAddExpenseBtn");
    const childTransactions = document.getElementById("childTransactions");
    const childLogoutBtn = document.getElementById("childLogoutBtn");

    const parentBalances = document.getElementById("parentBalances");
    const parentChildSelect = document.getElementById("parentChildSelect");
    const parentDesc = document.getElementById("parentDesc");
    const parentAmount = document.getElementById("parentAmount");
    const parentAddExpenseBtn = document.getElementById("parentAddExpenseBtn");
    const parentExpenseTableBody = document.getElementById("parentExpenseTableBody");
    const parentLogoutBtn = document.getElementById("parentLogoutBtn");

    let currentUserEmail = "";
    let currentChild = "";
    let unsubscribeChild = null;
    let unsubscribeParent = null;

    // Show/hide helpers
    function showElement(el) { el.style.display = "block"; }
    function hideElement(el) { el.style.display = "none"; }

    // Clear inputs helper
    function clearInputs(...inputs) {
      inputs.forEach(input => { input.value = ""; });
    }

    // On Google Sign-in
    googleSignInBtn.addEventListener("click", async () => {
      try {
        const result = await signInWithPopup(auth, provider);
        currentUserEmail = result.user.email.toLowerCase();
        handleUserLogin();
      } catch (e) {
        alert("Sign-in failed: " + e.message);
      }
    });

    // On auth state change (remember login)
    onAuthStateChanged(auth, user => {
      if (user) {
        currentUserEmail = user.email.toLowerCase();
        handleUserLogin();
      } else {
        currentUserEmail = "";
        resetToLogin();
      }
    });

    // Handle user login
    function handleUserLogin() {
      hideElement(googleSignInBtn);
      if (parents.includes(currentUserEmail)) {
        // Parent
        showElement(parentSection);
        hideElement(pinSection);
        hideElement(childSection);
        subscribeParent();
      } else {
        // Child login step
        showElement(pinSection);
        hideElement(childSection);
        hideElement(parentSection);
      }
    }

    // Reset to initial login UI
    function resetToLogin() {
      hideElement(childSection);
      hideElement(parentSection);
      hideElement(pinSection);
      showElement(googleSignInBtn);
      currentChild = "";
      if (unsubscribeChild) unsubscribeChild();
      if (unsubscribeParent) unsubscribeParent();
    }

    // Verify child PIN
    verifyPinBtn.addEventListener("click", () => {
      const selected = childSelect.value;
      const pin = pinInput.value.trim();
      if (!selected) return alert("Please select a child name.");
      if (pins[selected] === pin) {
        currentChild = selected;
        showChildDashboard();
      } else {
        alert("Incorrect PIN. Please try again.");
      }
    });

    // Show child dashboard
    function showChildDashboard() {
      hideElement(pinSection);
      showElement(childSection);
      childNameDisplay.textContent = currentChild;
      subscribeChild();
    }

    // Child logout
    childLogoutBtn.addEventListener("click", async () => {
      await signOut(auth);
      resetToLogin();
    });

    // Parent logout
    parentLogoutBtn.addEventListener("click", async () => {
      await signOut(auth);
      resetToLogin();
    });

    // Child adds expense (always negative)
    childAddExpenseBtn.addEventListener("click", async () => {
      const desc = childDesc.value.trim();
      const amt = parseFloat(childAmount.value);
      if (!desc) return alert("Please enter an expense description.");
      if (isNaN(amt) || amt <= 0) return alert("Please enter a positive amount.");

      try {
        await addDoc(collection(db, "expenses"), {
          child: currentChild,
          description: desc,
          amount: -Math.abs(amt),  // Always subtract for child
          date: Timestamp.now(),
          addedBy: "Child"
        });
        clearInputs(childDesc, childAmount);
      } catch (e) {
        alert("Failed to add expense: " + e.message);
      }
    });

    // Parent adds transaction (+ or -)
    parentAddExpenseBtn.addEventListener("click", async () => {
      const name = parentChildSelect.value;
      const desc = parentDesc.value.trim();
      const amt = parseFloat(parentAmount.value);
      if (!desc) return alert("Please enter a description.");
      if (isNaN(amt) || amt === 0) return alert("Please enter a non-zero amount.");

      try {
        await addDoc(collection(db, "expenses"), {
          child: name,
          description: desc,
          amount: amt, // Parent can add positive or negative
          date: Timestamp.now(),
          addedBy: "Parent"
        });
        clearInputs(parentDesc, parentAmount);
      } catch (e) {
        alert("Failed to add transaction: " + e.message);
      }
    });

    // Subscribe and show child data live
    function subscribeChild() {
      if (unsubscribeChild) unsubscribeChild();

      const q = query(collection(db, "expenses"), where("child", "==", currentChild));
      unsubscribeChild = onSnapshot(q, (snapshot) => {
        let balance = 0;
        childTransactions.innerHTML = "";

        snapshot.forEach(doc => {
          const data = doc.data();
          balance += data.amount;

          const li = document.createElement("li");
          li.textContent = `${data.description}: ${data.amount.toFixed(2)} Dhs on ${data.date.toDate().toLocaleDateString()} (Added by: ${data.addedBy})`;
          childTransactions.appendChild(li);
        });

        childBalanceSpan.textContent = balance.toFixed(2);
      });
    }

    // Subscribe and show parent data live
    function subscribeParent() {
      if (unsubscribeParent) unsubscribeParent();

      const q = query(collection(db, "expenses"));
      unsubscribeParent = onSnapshot(q, (snapshot) => {
        const balances = { Khadija: 0, Omar: 0, Emad: 0 };
        parentExpenseTableBody.innerHTML = "";

        snapshot.forEach(docSnap => {
          const data = docSnap.data();
          const { child, description, amount, date, addedBy } = data;

          if (balances[child] !== undefined) balances[child] += amount;

          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${child}</td>
            <td>${description}</td>
            <td style="color:${amount < 0 ? '#c0392b' : '#27ae60'}">${amount.toFixed(2)}</td>
            <td>${date.toDate().toLocaleDateString()}</td>
            <td>${addedBy}</td>
          `;
          parentExpenseTableBody.appendChild(tr);
        });

        parentBalances.innerHTML = "";
        Object.entries(balances).forEach(([child, bal]) => {
          const li = document.createElement("li");
          li.textContent = `${child}: ${bal.toFixed(2)} Dhs`;
          parentBalances.appendChild(li);
        });
      });
    }
  </script>
</body>
</html>
