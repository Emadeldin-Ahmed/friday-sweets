<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import {
    getFirestore, collection, query, where, orderBy, getDocs, addDoc,
    serverTimestamp, deleteDoc, doc
  } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
  import {
    getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAbpN6PKSiyD5nNcZNNRgshTTwUTs4A0po",
    authDomain: "friday-sweets.firebaseapp.com",
    projectId: "friday-sweets",
    storageBucket: "friday-sweets.firebasestorage.app",
    messagingSenderId: "772417277599",
    appId: "1:772417277599:web:f69df19ae71030af515caa"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  const parentalEmails = ["prof.ahmedemad@gmail.com"]; // ‚úÖ Your parental email here
  const childPins = {
    Khadija: "1234",
    Omar: "5678",
    Emad: "4321"
  };

  // --- UI ELEMENTS ---
  const loginBtn = document.getElementById("googleSignInBtn");
  const logoutBtn = document.getElementById("signOutBtn");
  const parentLogoutBtn = document.getElementById("parentSignOutBtn");
  const childSelect = document.getElementById("childSelect");
  const pinInput = document.getElementById("pinInput");
  const pinSubmitBtn = document.getElementById("pinSubmitBtn");
  const balanceEl = document.getElementById("balance");
  const expenseList = document.getElementById("expenseList");

  const parentExpenseTableBody = document.getElementById("parentExpenseTableBody");
  const parentBalances = document.getElementById("parentBalances");

  let currentUserEmail = null;
  let isParent = false;
  let currentChild = null;

  // üîí Sign in
  loginBtn.onclick = async () => {
    const provider = new GoogleAuthProvider();
    await signInWithPopup(auth, provider);
  };

  logoutBtn.onclick = () => signOut(auth);
  parentLogoutBtn.onclick = () => signOut(auth);

  onAuthStateChanged(auth, user => {
    if (user) {
      currentUserEmail = user.email;
      isParent = parentalEmails.includes(currentUserEmail);
      document.getElementById("loginSection").style.display = "none";

      if (isParent) {
        document.getElementById("parentSection").style.display = "block";
        loadParentData();
      } else {
        document.getElementById("childSection").style.display = "block";
      }
    }
  });

  childSelect.onchange = () => {
    currentChild = childSelect.value;
    document.getElementById("pinSection").style.display = "block";
    document.getElementById("pinChildName").textContent = currentChild;
  };

  pinSubmitBtn.onclick = async () => {
    const entered = pinInput.value.trim();
    if (entered === childPins[currentChild]) {
      document.getElementById("trackerSection").style.display = "block";
      document.getElementById("currentChildName").textContent = currentChild;
      await checkFridayTopUp(currentChild);
      await showBalance(currentChild);
    } else {
      document.getElementById("pinError").textContent = "Wrong PIN";
    }
  };

  async function checkFridayTopUp(child) {
    const expensesRef = collection(db, "expenses");
    const friday = new Date();
    friday.setDate(friday.getDate() - ((friday.getDay() + 2) % 7)); // last Friday
    friday.setHours(0, 0, 0, 0);

    const q = query(
      expensesRef,
      where("child", "==", child),
      where("description", "==", "Friday top-up")
    );
    const docs = await getDocs(q);
    let alreadyAdded = false;

    docs.forEach(doc => {
      const d = doc.data().timestamp?.toDate();
      if (d && d >= friday) alreadyAdded = true;
    });

    if (!alreadyAdded) {
      await addDoc(expensesRef, {
        child,
        description: "Friday top-up",
        amount: 10,
        timestamp: serverTimestamp()
      });
    }
  }

  async function showBalance(child) {
    const q = query(collection(db, "expenses"), where("child", "==", child));
    const docs = await getDocs(q);
    let total = 0;

    docs.forEach(doc => {
      total += doc.data().amount;
    });

    balanceEl.textContent = total.toFixed(2);
  }

  // üìä Parent Mode
  async function loadParentData() {
    const q = query(collection(db, "expenses"), orderBy("timestamp", "desc"));
    const docs = await getDocs(q);

    const balances = { Khadija: 0, Omar: 0, Emad: 0 };
    parentExpenseTableBody.innerHTML = "";

    docs.forEach(d => {
      const data = d.data();
      const date = data.timestamp?.toDate().toLocaleDateString() || "";
      balances[data.child] += data.amount;

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${data.child}</td>
        <td>${data.description}</td>
        <td>${data.amount.toFixed(2)}</td>
        <td>${date}</td>
        <td><button data-id="${d.id}" class="delBtn">üóëÔ∏è</button></td>
      `;
      parentExpenseTableBody.appendChild(tr);
    });

    document.querySelectorAll(".delBtn").forEach(btn => {
      btn.onclick = async () => {
        await deleteDoc(doc(db, "expenses", btn.dataset.id));
        loadParentData();
      };
    });

    parentBalances.innerHTML = "";
    for (const child in balances) {
      const li = document.createElement("li");
      li.textContent = `${child}: ${balances[child].toFixed(2)} Dhs`;
      parentBalances.appendChild(li);
    }
  }

  // ‚ûï Parent add money
  document.getElementById("parentAddExpenseBtn").onclick = async () => {
    const child = document.getElementById("parentChildSelect").value;
    const desc = document.getElementById("parentDesc").value.trim();
    const amount = parseFloat(document.getElementById("parentAmount").value);
    if (!desc || isNaN(amount)) return alert("Fill all fields correctly.");

    await addDoc(collection(db, "expenses"), {
      child,
      description: desc,
      amount,
      timestamp: serverTimestamp()
    });

    loadParentData();
  };
</script>
