<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Friday Sweets</title>
  <style>
    body {
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background: #f9f9f9;
      margin: 0;
      padding: 0;
      text-align: center;
      color: #333;
    }
    h1 { color: #4a90e2; }
    .container {
      max-width: 600px;
      margin: 20px auto;
      padding: 20px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    input, button {
      margin: 6px;
      padding: 10px;
      font-size: 1em;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      font-size: 0.95em;
    }
    th, td {
      padding: 8px;
      border: 1px solid #ccc;
    }
    th {
      background-color: #e0e0e0;
    }
    .logout {
      position: absolute;
      top: 10px;
      right: 10px;
      background: #ff4d4d;
      color: white;
      border: none;
      border-radius: 6px;
    }
  </style>
</head>
<body>
  <button class="logout" onclick="logout()">Logout</button>
  <div class="container">
    <h1>üç¨ Friday Sweets Tracker</h1>
    <div id="loginSection">
      <button onclick="loginWithGoogle()">Sign In with Google</button>
    </div>
    <div id="mainApp" style="display:none;">
      <p>Signed in as <strong id="userEmail"></strong></p>
      <h2>Your Balance: <span id="balance">0</span> Dhs</h2>
      <div id="childControls" style="display:none;">
        <input type="text" id="descInput" placeholder="What did you buy?">
        <input type="number" id="amountInput" placeholder="Amount (Dhs)">
        <button onclick="addExpense()">Add Expense</button>
      </div>
      <div id="parentControls" style="display:none;">
        <select id="selectChild">
          <option value="Khadija">Khadija</option>
          <option value="Omar">Omar</option>
          <option value="Emad">Emad</option>
        </select><br>
        <input type="number" id="parentAmount" placeholder="Amount">
        <input type="text" id="parentDesc" placeholder="Reason">
        <button onclick="addTransactionToChild(true)">Add Money</button>
        <button onclick="addTransactionToChild(false)">Take Away</button>
      </div>
      <h3>üßæ Transactions</h3>
      <table>
        <thead>
          <tr><th>Child</th><th>Description</th><th>Amount</th><th>By</th><th>Date</th></tr>
        </thead>
        <tbody id="txnTable"></tbody>
      </table>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import {
      getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAbpN6PKSiyD5nNcZNNRgshTTwUTs4A0po",
      authDomain: "friday-sweets.firebaseapp.com",
      projectId: "friday-sweets",
      storageBucket: "friday-sweets.appspot.com",
      messagingSenderId: "772417277599",
      appId: "1:772417277599:web:f69df19ae71030af515caa"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const parents = ["prof.ahmedemad@gmail.com", "anotherparent@email.com"];
    let currentUser = null;

    function loginWithGoogle() {
      const provider = new GoogleAuthProvider();
      signInWithPopup(auth, provider).catch(console.error);
    }

    function logout() {
      signOut(auth);
    }

    onAuthStateChanged(auth, user => {
      if (user) {
        currentUser = user;
        document.getElementById("loginSection").style.display = "none";
        document.getElementById("mainApp").style.display = "block";
        document.getElementById("userEmail").textContent = user.email;
        const isParent = parents.includes(user.email);
        document.getElementById("parentControls").style.display = isParent ? "block" : "none";
        document.getElementById("childControls").style.display = isParent ? "none" : "block";
        loadTransactions();
      } else {
        currentUser = null;
        document.getElementById("mainApp").style.display = "none";
        document.getElementById("loginSection").style.display = "block";
      }
    });

    function loadTransactions() {
      const txnRef = collection(db, "transactions");
      const q = query(txnRef, orderBy("date", "desc"));
      onSnapshot(q, snapshot => {
        let balance = 0;
        let html = "";
        snapshot.forEach(doc => {
          const tx = doc.data();
          const amt = Number(tx.amount);
          if (currentUser && (parents.includes(currentUser.email) || tx.child === getChildName(currentUser.email))) {
            balance += amt;
            html += `
              <tr>
                <td>${tx.child}</td>
                <td>${tx.description}</td>
                <td>${amt.toFixed(2)}</td>
                <td>${tx.addedBy || "Unknown"}</td>
                <td>${tx.date?.toDate ? tx.date.toDate().toLocaleDateString() : "Unknown"}</td>
              </tr>`;
          }
        });
        document.getElementById("balance").textContent = balance.toFixed(2);
        document.getElementById("txnTable").innerHTML = html;
      });
    }

    function getChildName(email) {
      if (email.includes("khadija")) return "Khadija";
      if (email.includes("omar")) return "Omar";
      return "Emad";
    }

    async function addExpense() {
      const desc = document.getElementById("descInput").value.trim();
      const amt = parseFloat(document.getElementById("amountInput").value);
      if (!desc || isNaN(amt)) return alert("Enter valid details");
      await addDoc(collection(db, "transactions"), {
        child: getChildName(currentUser.email),
        description: desc,
        amount: -Math.abs(amt),
        date: serverTimestamp(),
        addedBy: currentUser.email
      });
      document.getElementById("descInput").value = "";
      document.getElementById("amountInput").value = "";
    }

    async function addTransactionToChild(isAdding) {
      const child = document.getElementById("selectChild").value;
      const amt = parseFloat(document.getElementById("parentAmount").value);
      const desc = document.getElementById("parentDesc").value.trim();
      if (!child || isNaN(amt) || !desc) return alert("Fill in all fields.");
      const amount = isAdding ? Math.abs(amt) : -Math.abs(amt);
      await addDoc(collection(db, "transactions"), {
        child,
        description: desc,
        amount,
        date: serverTimestamp(),
        addedBy: currentUser.email
      });
      document.getElementById("parentAmount").value = "";
      document.getElementById("parentDesc").value = "";
    }
  </script>
</body>
</html>
